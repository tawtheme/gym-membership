<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Ionic App</title>

    <base href="/" />

    <meta name="color-scheme" content="light dark" />
    <meta name="viewport"
        content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />

    <link rel="icon" type="image/png" href="assets/icon/favicon.png" />

    <!-- Material Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

    <!-- add to homescreen for ios -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />

    <!-- jeep-sqlite for web platform -->
    <script type="module" src="assets/jeep-sqlite/jeep-sqlite.esm.js"></script>
    <script>
        // Suppress WASM errors in console - they're expected during initialization
        // These errors occur when WASM tries to instantiate but are handled internally by jeep-sqlite

        const originalError = console.error;
        const originalWarn = console.warn;

        // Filter WASM-related errors from console.error
        console.error = function (...args) {
            const message = args[0]?.toString() || '';
            const fullMessage = args.map(arg => String(arg)).join(' ');

            // Filter out known WASM LinkError and RuntimeError messages
            if (fullMessage.includes('LinkError: WebAssembly.instantiate()') ||
                fullMessage.includes('RuntimeError: Aborted') ||
                (fullMessage.includes('WebAssembly') && fullMessage.includes('function import requires a callable')) ||
                fullMessage.includes('falling back to ArrayBuffer instantiation')) {
                // These errors are expected during WASM initialization and are handled internally
                return;
            }
            originalError.apply(console, args);
        };

        // Filter WASM-related warnings from console.warn
        console.warn = function (...args) {
            const fullMessage = args.map(arg => String(arg)).join(' ');

            if (fullMessage.includes('falling back to ArrayBuffer instantiation') ||
                fullMessage.includes('WebAssembly') && fullMessage.includes('instantiate')) {
                return;
            }
            originalWarn.apply(console, args);
        };

        // Catch uncaught exceptions related to WASM
        window.addEventListener('error', function (event) {
            const message = event.message || '';
            const errorString = event.error?.toString() || '';
            const fullMessage = message + ' ' + errorString;

            if (fullMessage.includes('LinkError: WebAssembly.instantiate()') ||
                fullMessage.includes('RuntimeError: Aborted') ||
                (fullMessage.includes('WebAssembly') && fullMessage.includes('function import requires a callable'))) {
                event.preventDefault();
                event.stopPropagation();
                return false;
            }
        }, true);

        // Ensure jeep-sqlite loads before Angular
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded - Checking jeep-sqlite...');

            // Wait for custom element to be defined
            const checkJeepSqlite = setInterval(() => {
                const jeepElement = document.querySelector('jeep-sqlite');
                const isDefined = customElements.get('jeep-sqlite');

                if (jeepElement && isDefined) {
                    console.log('jeep-sqlite custom element is ready!');
                    clearInterval(checkJeepSqlite);
                }
            }, 100);

            // Stop checking after 10 seconds
            setTimeout(() => {
                clearInterval(checkJeepSqlite);
                const jeepElement = document.querySelector('jeep-sqlite');
                const isDefined = customElements.get('jeep-sqlite');
                if (!jeepElement || !isDefined) {
                    console.warn('jeep-sqlite may not be fully loaded');
                }
            }, 10000);
        });
    </script>
</head>

<body>
    <!-- wasmPath must point to the folder that contains sql-wasm.wasm -->
    <!-- In this project sql-wasm.wasm is directly under /assets -->
    <jeep-sqlite autoSave="true" wasmPath="/assets" typeOrm="false"></jeep-sqlite>
    <app-root></app-root>
</body>

</html>